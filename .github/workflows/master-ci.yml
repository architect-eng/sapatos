name: master-ci 

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  master-ci:
    timeout-minutes: 30
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # Test all PostgreSQL versions on Node 22.x (stable)
          - node-version: 22.x
            postgres-version: "17"
          - node-version: 22.x
            postgres-version: "16"
          - node-version: 22.x
            postgres-version: "15"
          - node-version: 22.x
            postgres-version: "14"
          - node-version: 22.x
            postgres-version: "13"
          # Test all Node versions on PostgreSQL 17 (latest stable)
          - node-version: 20.x
            postgres-version: "17"
          - node-version: 24.x
            postgres-version: "17"

    steps:
    - uses: actions/checkout@v6

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - run: npm ci

    - run: npm run lint

    - run: npm run typecheck

    - run: npm run build

    - run: npm run test

    - name: Run integration tests with PostgreSQL ${{ matrix.postgres-version }}
      run: npm run integration-tests
      env:
        POSTGRES_VERSION: ${{ matrix.postgres-version }}
